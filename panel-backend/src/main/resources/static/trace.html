<!doctype html>
<html lang="zh Hang ">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>追蹤所在場所</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.js"></script>
</head>

<style>

    body {
        background-image: linear-gradient(rgba(255,255,255,0.1), rgba(255,255,255,0.1)),
        url("/image/trace_background.jpg") !important;
        background-position: center !important;
        background-size: cover !important;
        background-repeat: no-repeat !important;
        background-attachment: scroll;

        color:white;
        font-family:  "Noto Sans TC", sans-serif ;

    }

    .element{

        font-family: "Comic Sans MS", "Bradley Hand", "Segoe Script", cursive ;
        font-size: 28px;
        color:black;
        background-color: beige;
        background-color: rgba(255,255,255,0.8);
        border-radius:10px;
        transition: background-color 0.25s;
        flex-direction: column;
        /*justify-content: center;*/
        /*align-items: center;*/
        display: flex;
        padding: 32px 48px;


    }
    .element h2,
    .element h3{
        font-size: 32px;
        font-family: "Comic Sans MS", "Bradley Hand", "Segoe Script", cursive;
        margin-bottom: 12px;
    }

    .element p {
        font-size: 20px;
        margin: 6px 0;
    }
    .element button {
        background-color: white;
        color: black;
        font-size: 14px;
        padding: 6px 14px;
        border-radius: 8px;
        border: black solid 1px;
        cursor: pointer;
        margin-top: 8px;
    }
    .element dialog{
        background-color:white;
        color: black;
        font-size: 14px;
        padding: 8px 20px;
        border-radius: 8px;
        border: black solid 1px;
        cursor: pointer;
    }



    .element:hover{
        background-color: #F3F3FA;
        background-color: rgba(255,255,255,0.5);

    }

    .lon_lat{
       display: flex;
        justify-content: center;
    }


    .kite {
        --size: 40px; --body:#ff6b6b; --body2:#ff3b3b;
        --border: rgba(0,0,0,.15); --stick: rgba(255,255,255,.85);
        --bow:#ffcc80; --gloss: rgba(255,255,255,.25);
    }
    .kite-wrapper{
        top:4vh;
        left:-3vh;
        position: relative; width: calc(var(--size)*1.6); height: calc(var(--size)*1.6);
        animation: bob 2.2s ease-in-out  infinite alternate;

    }
    .kite{
        position:absolute; left:50%; top:50%;
        width:var(--size); height:var(--size);
        transform:translate(-50%,-50%) rotate(45deg);
        background:linear-gradient(135deg,var(--body),var(--body2));
        border-radius:6px; box-shadow:0 8px 18px rgba(0,0,0,.22), inset 0 0 0 1px var(--border);
    }
    .kite-slot{
        height: calc(var(--size) * 1.6 + 6vh); /* 6vh ≈ 上下晃動空間，可再調 */
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: visible; /* 讓尾巴超出也看得到 */
    }
    .kite::before{
        content:""; position:absolute; inset:0;
        background:
                linear-gradient(var(--stick),var(--stick)) 50% 0/3px 100% no-repeat,
                linear-gradient(var(--stick),var(--stick)) 0 50%/100% 3px no-repeat;
    }
    .kite::after{
        content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
        background: radial-gradient(120px 60px at 80% 15%, var(--gloss), transparent 60%);
    }
    .tail{
        position:absolute; left:50%; top:calc(100% + 8px);
        transform:translateX(-50%); transform-origin:top center;
        width:0.5px; height:calc(var(--size)*1.6);
        background:linear-gradient(var(--stick),var(--stick));
        animation:swayTail 2.6s ease-in-out infinite;
    }
    .tail span{ position:absolute; left:-5px; width:10px; height:6px; background:var(--bow);
        border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,.25); }
    .tail span:nth-child(1){ top:11px;  transform:rotate(16deg); }
    .tail span:nth-child(2){ top:30px;  transform:rotate(-10deg); }
    .tail span:nth-child(3){ top:48px;  transform:rotate(14deg); }
    .tail span:nth-child(4){ top:69px;  transform:rotate(-6deg); }
    .tail span:nth-child(5){ top:90px; transform:rotate(12deg); }

    @keyframes bob{
        0%   { transform: translateY(0); }
        50%  { transform: translateY(-2vh); }
        100% { transform: translateY(2vh); }
    }
    @keyframes swayTail{
        0%,100%{ transform:translateX(-50%) rotate(-6deg); }
        50%{ transform:translateX(-50%) rotate(6deg); }
    }

    .kite-row {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 50px;

    }
    .phase {

        margin-top:8px ;
        line-height :1.6;
        max-width: var(--size);
        position: relative;
        top: 20px; /* 讓整段文字略微下移 */
        font-family: "Comic Sans MS", "Bradley Hand", "Segoe Script", cursive;
        font-size: 30px;

    }
    @media(max-width: 600px){
        .kite-row {
            flex-direction: column;
            align-items: center;

        }


    }

    .adjust-text{
        display:flex;
        flex-direction: column;
        justify-content : center;
        align-items: center;
        flex-wrap:  wrap;


    }

</style>


<body>

    <div class="flex justify-center items-center min-h-screen">

       <div class = "element">


         <div class = "adjust-text">
             <div class = "text">

             <h2> 正在追蹤您的裝置地理資訊</h2>
                 <div class = "lon_lat">
              <p id = "location" ></p>
                     </div>
                 </div>

             <div class = "kite-row">
               <div class="kite-slot">
                   <div class="kite-wrapper" >
                       <div class="kite">

                           <div class="tail"> <span></span><span></span><span></span><span></span><span></span>
                           </div>
                       </div>

                   </div>
           </div>
                 <div class = "flex justify-center phase">
                 <p >場所登記還剩: <span id = "timer"></span>秒
                     <br><span id ="locationList"></span></p>
                     </div>
       </div>
         </div>
       </div>
       </div>





    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    //這段原本的語法當中少了非同步的概念，意思是當腳本呼叫API數據並不會理可以以物件的姿態馬上成為腳本的權域變數，
    // 根據不同API的需要使用譬如像callback函數之類的方法去把需要的物件招回。

    // 如果確認裝置是否離開特定區域，重心應該要放在“誤差”上而非地點本身，也就是說一開始就可以將所需要的誤差物件給定義出來。

    //今天debug 弄老半弄了一堆測試連後端都多配置了一些依靠，做結果只是網頁的快取沒有釋放掉，下次遇到這種不知道問題出在哪的狀況，
    //最重要的是細心的觀察遭遇到的所有過程，並且細心的一一推敲因果，往前的路上必定要去適應新環境。


    //一個場所一天設定一次




    //明天要成功讓經緯度送到後端，回傳placeDetail，在時效到達後前端呈現地點選項，點選後登記地點資訊進入SQL。這一連串的動作。

      const x = document.getElementById("location");
      const x1= document.getElementById("locationList")
      const x2 = document.getElementById("timer")




      const DWELL_MS = 10000;
      const CHECK_EVERY_MS = 1000;
      const LAT_DELTA = 0.00005;
      const LNG_DELTA = 0.00005;


      let anchorPos =  null;
      let lastPos = null ;
      let stillInThere = true;
      let startedAt = Date.now();
      let posName = null ;
      let posDetail= null;
      let remaining = DWELL_MS


      if ( !('geolocation' in navigator )) {
        x.textContent = "此瀏覽器不支援地理位置。"
      }

      else {



         const watchId  =  navigator.geolocation.watchPosition(  (pos)=> {
             console.log("watchId為:", watchId);


             lastPos = pos;
             if (!anchorPos) anchorPos = pos;

             const {latitude, longitude} = pos.coords;
             const afterLat = pos.coords.latitude.toFixed(5);
             const  afterLong = pos.coords.longitude.toFixed(5)
             x.innerHTML =`經度: ${afterLat}  緯度: ${afterLong}`;


             const dLAT = Math.abs(latitude - anchorPos.coords.latitude);
             const dLNG = Math.abs(longitude - anchorPos.coords.longitude);

             if (dLAT > LAT_DELTA || dLNG > LNG_DELTA) {

                 stillInThere = false //邏輯上真實世界不符合情境
             }
             },

             (err) => {
                 x.textContent = `定位失敗: ${err.message}, (code ${err.code}) `;
                 console.log('定位失敗', err);
             },
                 {enableHighAccuracy: true, timeout: 100000, maximumAge: 0}
         )

          // JS的一大特點是可以將函數定濃縮一個常數ID去確認執行的先後順序。
          // 設計每天登載一次，24小時後重新紀錄，後端還要加上累計次數，理想情況應該是每一次記場所位置都新增一筆條目到
          // 後端的資料庫才是，那麼問題是，如果用setInterval去設定時追蹤的功能網頁就勢必就得一直開著，
          // 在理想的情況下我希望瀏覽器會替我記憶這個函數的“狀態”，這個狀態告訴我什麼時候使用過、使用帶來的結果是什麼諸如此類被記憶下的
          // “有用的資訊"，讓我能夠根據這個“狀態”近一步做操作，現在我能夠直覺想到的是cookie的技術（錯誤，應該使用localstorage，cookie是專門用於登入狀態與偏好設定，記憶的目的主要用於與後端做互動。調閱伺服器資料。）
          // 。也就是說如果我要記憶這個函數的使用時間再加以操作，中間是必有一連串與瀏覽器互動的過程是我要去設計的。
          //所以我要寫一段 localstorage

          //位置要持續做監控，然而30分鐘（時間區段到期後要重新計時開始新的一run），
          //在功能上計時跟監聽位置不能停止，把送出資料的條件限定在送出資聊的scope。
         // 取得地裡位置名稱

          async function getLocationDetail(longitude,latitude){

             const url = `/locationDetail?longitude=${longitude}&latitude=${latitude}`

              //這邊設計可以跳出選項的頁面

              try {
                  const response = await fetch(url);
                  const data = await response.json();
                  console.log("回傳資料:",data);

                  if (data) {
                      return data;
                  } else console.log('找不到地理名稱！')
                  return "未知地理名稱"
              }catch (err){  console.log('資料取得失敗')
             return "錯誤"
             }

          }



          async  function  sendData (url,payload) {


              try {

                  console.log("準備送出的資料:", payload);
                  const res = await fetch(url, {
                          method: "POST",
                          headers: {"Content-Type": "application/json"},
                          body: JSON.stringify(payload)
                      }
                  )
                  const ct = res.headers.get("Content-Type") || '';
                  let result = null;
                  if (res.ok && ct.includes("application/json")) {
                      result = await res.json();// 這邊要記載成功時間

                      const now = new Date;
                      localStorage.setItem("地點登錄時間", now.toISOString());
                      console.log("地點登錄時間為:", localStorage.getItem("地點登錄時間"));

                  } else if (res.status === 204) {
                      result = {status: "no_content"};
                  } else if (!res.ok) {
                      throw new Error("HTTP" + res.status);
                  }

                  console.log('停留時間已超過30分鐘，已登記！', result);
                  localStorage.setItem("result",JSON.stringify(result))


              } catch (err) {
                  console.log('送出失敗', err);
              }
          }




          setInterval( async() => {

              const now = Date.now();
              console.log("地理位置為:", lastPos.coords.longitude);
              console.log("startedAt:",startedAt);
              console.log("現在時間:",now );

              remaining = Math.ceil((DWELL_MS - (now - startedAt))/1000);
              x2.innerHTML=remaining


              if (now - startedAt > DWELL_MS) {


                  // let d1 = new Date();
                  // const today = d1.getDate();
                  // let d2 = new Date(localStorage.getItem("地點登錄時間"));
                  // const enrollDate = d2.getDate()
                  //
                  //  let m1 = new Date();
                  //  const thisMinute = m1.getMinutes();
                  //  console.log("當下分鐘數!",thisMinute)
                  //  let m2 = new Date(localStorage.getItem("地點登錄時間"));
                  //  const enrollMinute = m2.getMinutes();
                  //  console.log("登錄時分鐘數！",enrollMinute)  && thisMinute>enrollMinute
                  if (stillInThere && lastPos) {

                      posDetail = await getLocationDetail(lastPos.coords.longitude, lastPos.coords.latitude);
                      let results = posDetail.placeResponse.results;
                      console.log("資料回傳為:", results);


                      if (results) {
                          const posCandidate = [];
                          for (let i = 0; i < results.length; i++) {
                              posCandidate.push(results[i].name);
                          }

                          console.log("地名陣列為", posCandidate);

                      }

                      //到這邊彈出選項。
                      loadOption();

                      function loadOption() {

                          x1.innerHTML = `<dialog id="list">
                                          <h3> 附近場所：</h3>
                                         <div id="place"></div>
                                         <button id = "closeDialog"> 關閉</button>
                                        </dialog>`;

                      }

                      const dialog = document.getElementById("list");
                      const closeDialog = document.getElementById("closeDialog");
                      const enrollDialog = document.getElementById("enrollDialog");
                      // dialog.classList.add('border-1','border-black','bg-gray-100','text-black');



                      function showList() {

                          document.getElementById('list').showModal();
                          closeDialog.addEventListener("click", () => {
                                  dialog.close();
                                  window.location.reload();
                              }
                          )
                      }


                      const placeList = document.getElementById("place");
                      //這是一個物件節點

                      showPos(results);

                      //DOM的概念不熟
                      function showPos(results) {

                          for (let i = 0; i < results.length; i++) {

                              const chooseBtn = document.createElement("button")
                              chooseBtn.textContent = results[i].name;
                              chooseBtn.addEventListener("click", () => checkPos(i));
                              placeList.appendChild(chooseBtn);

                              //把元素當成
                              placeList.appendChild(document.createElement("br"));

                          }

                          const btn = document.createElement("button")
                          // btn.classList.add('border-2','border-black','bg-gray-100','text-black','rounded-lg','shadow-lg');
                          btn.textContent = "點我挑選你所在的地方！";
                          btn.addEventListener("click", showList);
                          x1.appendChild(btn);



                      }


                      //先把邏輯敲對再去確認語法問題。
                      function checkPos(i) {

                          const locationJournal = {
                              latitude: posDetail.latitude,
                              longitude: posDetail.longitude,
                              acquiringTime: new Date().toISOString(),
                              publicName: posDetail.placeResponse.results[i].name,
                              address: posDetail.placeResponse.results[i].vicinity,
                              poi: posDetail.placeResponse.results[i].types.toString(),
                              placeId: posDetail.placeResponse.results[i].place_id
                          };


                          console.log("資料已登載", locationJournal)
                          sendData("/location", locationJournal)
                          dialog.close();
                          alert("場所登記成功！");


                      }

                  } else {
                      console.log('中途離開，不登記!')
                  }


                  startedAt = Date.now();
              }

              console.log('尚未到達30分鐘');
              }
              ,
              CHECK_EVERY_MS)
      }






    </script>



    </body>
</html>
